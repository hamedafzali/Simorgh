import "@/i18n/config";
import AsyncStorage from "@react-native-async-storage/async-storage";
import { useRouter } from "expo-router";
import React, { useEffect, useRef, useState } from "react";
import { useTranslation } from "react-i18next";
import { LinearGradient } from "expo-linear-gradient";
import {
  Animated,
  ScrollView,
  StyleSheet,
  Switch,
  TouchableOpacity,
  View,
} from "react-native";

import { ThemedText } from "@/components/themed-text";
import { ThemedView } from "@/components/themed-view";
import { IconSymbol } from "@/components/ui/icon-symbol";
import { ModernButton } from "@/components/ui/modern-button";
import PageHeader from "@/components/ui/page-header";
import { Spacing, Typography } from "@/constants/theme";
import { useTheme } from "@/contexts/theme-context";

const styles = StyleSheet.create({
  container: {
    flex: 1,
  },
  backgroundGradient: {
    position: "absolute",
    top: 0,
    left: 0,
    right: 0,
    height: 100,
    zIndex: 5,
  },
  glassHeader: {
    position: "absolute",
    top: 0,
    left: 0,
    right: 0,
    height: 100,
    paddingTop: 50,
    paddingHorizontal: Spacing.lg,
    paddingBottom: Spacing.sm,
    zIndex: 20,
  },
  headerContent: {
    flex: 1,
    flexDirection: "row",
    alignItems: "center",
    justifyContent: "space-between",
    minHeight: 40,
  },
  headerTitle: {
    fontSize: Typography.sizes["3xl"],
    fontWeight: Typography.weights.semibold,
    flex: 1,
    textAlign: "center",
    marginHorizontal: Spacing.sm,
    marginTop: -35,
  },
  backButton: {
    width: 36,
    height: 36,
    borderRadius: 18,
    alignItems: "center",
    justifyContent: "center",
    marginTop: -48,
  },
  headerSpacer: {
    width: 36,
    height: 36,
  },
  content: {
    paddingHorizontal: Spacing.lg,
    paddingTop: 120,
    gap: Spacing.lg,
    paddingBottom: Spacing.xl,
  },
  card: {
    borderRadius: 16,
    padding: Spacing.lg,
    borderWidth: 1,
    shadowColor: "#000",
    shadowOpacity: 0.1,
    shadowRadius: 8,
    shadowOffset: { width: 0, height: 4 },
    elevation: 3,
    marginBottom: Spacing.lg,
  },
  cardTitle: {
    fontSize: Typography.sizes["2xl"],
    fontWeight: Typography.weights.semibold,
    marginBottom: Spacing.md,
  },
  settingItem: {
    flexDirection: "row",
    alignItems: "center",
    justifyContent: "space-between",
    padding: Spacing.md,
    borderRadius: 12,
    marginBottom: Spacing.sm,
  },
  settingLeft: {
    flexDirection: "row",
    alignItems: "center",
    flex: 1,
  },
  settingIcon: {
    width: 40,
    height: 40,
    borderRadius: 20,
    backgroundColor: "rgba(59, 130, 246, 0.2)",
    alignItems: "center",
    justifyContent: "center",
    marginRight: Spacing.md,
  },
  settingText: {
    flex: 1,
  },
  settingTitle: {
    fontSize: Typography.sizes.base,
    fontWeight: Typography.weights.semibold,
    marginBottom: 4,
  },
  settingDescription: {
    fontSize: Typography.sizes.sm,
    lineHeight: 20,
  },
  languageRow: {
    flexDirection: "row",
    gap: Spacing.sm,
    marginTop: Spacing.md,
  },
  languageButton: {
    flex: 1,
    paddingVertical: Spacing.sm,
    paddingHorizontal: Spacing.md,
    borderRadius: 8,
    alignItems: "center",
    borderWidth: 1,
  },
  languageButtonActive: {
    backgroundColor: "#3B82F6",
    borderColor: "#3B82F6",
  },
  languageText: {
    fontSize: Typography.sizes.sm,
    fontWeight: Typography.weights.semibold,
  },
});

export default function SettingsScreen() {
  const { t, i18n } = useTranslation();
  const router = useRouter();
  const fadeAnim = useRef(new Animated.Value(0)).current;
  const [notifications, setNotifications] = useState(true);
  const [currentLanguage, setCurrentLanguage] = useState(i18n.language);
  const [, forceUpdate] = React.useReducer((x) => x + 1, 0);

  // Use centralized theme
  const { themeName, setTheme, colors, availableThemes } = useTheme();

  const handleChangeLanguage = async (lng: "fa" | "de" | "en") => {
    try {
      console.log("Changing language to:", lng);
      await i18n.changeLanguage(lng);
      setCurrentLanguage(lng);
      forceUpdate(); // Force re-render
      console.log("Language changed successfully to:", i18n.language);

      // Try to save to AsyncStorage (optional, won't break if it fails)
      try {
        await AsyncStorage.setItem("Simorgh.language", lng);
      } catch (storageError) {
        console.log("Language save error (non-critical):", storageError);
      }
    } catch (error: any) {
      console.warn("changeLanguage error", error);
    }
  };

  useEffect(() => {
    // Load saved language and dark mode on component mount
    const loadSavedSettings = async () => {
      try {
        // Load language
        const savedLanguage = await AsyncStorage.getItem("Simorgh.language");
        if (savedLanguage) {
          setCurrentLanguage(savedLanguage);
          await i18n.changeLanguage(savedLanguage);
        }

        // Load dark mode
        const savedDarkMode = await AsyncStorage.getItem("Simorgh.darkMode");
        if (savedDarkMode !== null) {
          // Theme is managed by ThemeProvider, no need to set local state
        }
      } catch (error: any) {
        console.warn("Error loading saved settings:", error);
        // Continue with defaults if AsyncStorage fails
      }
    };

    loadSavedSettings();

    // Listen for language changes
    const handleLanguageChanged = () => {
      forceUpdate();
    };

    i18n.on("languageChanged", handleLanguageChanged);

    // Cleanup
    return () => {
      i18n.off("languageChanged", handleLanguageChanged);
    };
  }, [i18n, forceUpdate]);

  // Start fade-in animation
  useEffect(() => {
    Animated.timing(fadeAnim, {
      toValue: 1,
      duration: 1000,
      useNativeDriver: true,
    }).start();
  }, [fadeAnim]);

  return (
    <View
      style={[styles.container, { backgroundColor: colors.background }]}
      key={currentLanguage}
    >
      {/* Page Header */}
      <PageHeader
        title="Settings"
        showBackButton={true}
        onBackPress={() => router.back()}
        height="medium"
      />

      <ScrollView
        contentContainerStyle={styles.content}
        showsVerticalScrollIndicator={false}
      >
        <Animated.View style={[{ opacity: fadeAnim }]}>
          <ThemedView style={styles.card}>
            <ThemedText type="heading" style={styles.cardTitle}>
              {t("settings.preferences")}
            </ThemedText>

            <View style={styles.settingItem}>
              <View style={styles.settingLeft}>
                <View style={styles.settingIcon}>
                  <IconSymbol name="bell.fill" size={20} color="#3B82F6" />
                </View>
                <View style={styles.settingText}>
                  <ThemedText style={styles.settingTitle}>
                    {t("settings.notifications")}
                  </ThemedText>
                  <ThemedText style={styles.settingDescription}>
                    {t("settings.notificationsDesc")}
                  </ThemedText>
                </View>
              </View>
              <Switch
                value={notifications}
                onValueChange={setNotifications}
                trackColor={{ false: "#374151", true: "#3B82F6" }}
                thumbColor={notifications ? "#FFFFFF" : "#9CA3AF"}
              />
            </View>

            <View style={styles.settingItem}>
              <View style={styles.settingLeft}>
                <View style={styles.settingIcon}>
                  <IconSymbol
                    name="paintbrush.fill"
                    size={20}
                    color={colors.primary}
                  />
                </View>
                <View style={styles.settingText}>
                  <ThemedText style={styles.settingTitle}>Theme</ThemedText>
                  <ThemedText style={styles.settingDescription}>
                    Choose your preferred theme
                  </ThemedText>
                </View>
              </View>
            </View>

            {/* Theme Options */}
            {availableThemes.map((theme) => (
              <TouchableOpacity
                key={theme.name}
                style={[
                  styles.languageButton,
                  {
                    backgroundColor: colors.card,
                    borderColor: colors.border,
                    ...(themeName === theme.name && {
                      backgroundColor: colors.primary,
                      borderColor: colors.primary,
                    }),
                  },
                ]}
                onPress={() => {
                  console.log("Theme button pressed:", theme.name);
                  setTheme(theme.name);
                }}
              >
                <ThemedText
                  style={[
                    styles.languageText,
                    {
                      color: themeName === theme.name ? "#FFFFFF" : colors.text,
                    },
                  ]}
                >
                  {theme.label}
                </ThemedText>
              </TouchableOpacity>
            ))}

            <View style={styles.settingItem}>
              <View style={styles.settingLeft}>
                <View style={styles.settingIcon}>
                  <IconSymbol name="globe" size={20} color="#3B82F6" />
                </View>
                <View style={styles.settingText}>
                  <ThemedText style={styles.settingTitle}>
                    {t("settings.language")}
                  </ThemedText>
                  <ThemedText style={styles.settingDescription}>
                    {t("settings.languageDesc")}
                  </ThemedText>
                </View>
              </View>
            </View>

            <View style={styles.languageRow}>
              <TouchableOpacity
                style={[
                  styles.languageButton,
                  { backgroundColor: colors.card, borderColor: colors.border },
                  currentLanguage === "fa" && {
                    backgroundColor: "#3B82F6",
                    borderColor: "#3B82F6",
                  },
                ]}
                onPress={() => handleChangeLanguage("fa")}
              >
                <ThemedText style={styles.languageText}>فارسی</ThemedText>
              </TouchableOpacity>

              <TouchableOpacity
                style={[
                  styles.languageButton,
                  { backgroundColor: colors.card, borderColor: colors.border },
                  currentLanguage === "de" && {
                    backgroundColor: "#3B82F6",
                    borderColor: "#3B82F6",
                  },
                ]}
                onPress={() => handleChangeLanguage("de")}
              >
                <ThemedText style={styles.languageText}>Deutsch</ThemedText>
              </TouchableOpacity>

              <TouchableOpacity
                style={[
                  styles.languageButton,
                  { backgroundColor: colors.card, borderColor: colors.border },
                  currentLanguage === "en" && {
                    backgroundColor: "#3B82F6",
                    borderColor: "#3B82F6",
                  },
                ]}
                onPress={() => handleChangeLanguage("en")}
              >
                <ThemedText style={styles.languageText}>English</ThemedText>
              </TouchableOpacity>
            </View>
          </ThemedView>

          <ThemedView style={styles.card}>
            <ThemedText type="heading" style={styles.cardTitle}>
              {t("settings.about")}
            </ThemedText>

            <View style={styles.settingItem}>
              <View style={styles.settingLeft}>
                <View style={styles.settingIcon}>
                  <IconSymbol
                    name="info.circle.fill"
                    size={20}
                    color="#3B82F6"
                  />
                </View>
                <View style={styles.settingText}>
                  <ThemedText style={styles.settingTitle}>
                    {t("settings.version")}
                  </ThemedText>
                  <ThemedText style={styles.settingDescription}>
                    {t("settings.versionText")}
                  </ThemedText>
                </View>
              </View>
            </View>

            <View style={styles.settingItem}>
              <View style={styles.settingLeft}>
                <View style={styles.settingIcon}>
                  <IconSymbol name="heart.fill" size={20} color="#3B82F6" />
                </View>
                <View style={styles.settingText}>
                  <ThemedText style={styles.settingTitle}>
                    {t("settings.rateApp")}
                  </ThemedText>
                  <ThemedText style={styles.settingDescription}>
                    {t("settings.rateAppDesc")}
                  </ThemedText>
                </View>
              </View>
            </View>
          </ThemedView>
        </Animated.View>
      </ScrollView>
    </View>
  );
}
